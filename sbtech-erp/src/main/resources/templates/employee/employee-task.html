<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<th:block th:fragment="content">

    <h1 class="page-title">ë‚´ ì—…ë¬´</h1>

    <!-- ğŸ”¹ í†µê³„ ì¹´ë“œ -->
    <div class="stats">
        <div class="stat-card">
            <h3 id="progressCount">0</h3><p>ì§„í–‰ ì¤‘</p>
        </div>
        <div class="stat-card">
            <h3 id="waitingCount">0</h3><p>ì‹œì‘ ì „</p>
        </div>
        <div class="stat-card">
            <h3 id="doneCount">0</h3><p>ì™„ë£Œ</p>
        </div>
    </div>

    <!-- ğŸ”¹ ê²€ìƒ‰ / í•„í„° -->
    <div class="filters">
        <input type="text" class="task-search" id="searchInput" placeholder="ì—…ë¬´ ê²€ìƒ‰" />
        <select class="task-filter" id="filterSelect">
            <option value="ALL">ì „ì²´ë³´ê¸°</option>
            <option value="IN_PROGRESS">ì§„í–‰ ì¤‘</option>
            <option value="WAITING">ì‹œì‘ ì „</option>
            <option value="DONE">ì™„ë£Œ</option>
        </select>
    </div>

    <!-- ğŸ”¹ ì—…ë¬´ ëª©ë¡ í…Œì´ë¸” -->
    <table class="task-table">
        <thead>
        <tr>
            <th>ì—…ë¬´ëª…</th>
            <th>ë‚´ìš©</th>
            <th>ë§ˆê°ì¼</th>
            <th>ìƒíƒœ</th>
            <th>ì‘ì—…</th> <!-- ğŸ”¥ ìŠ¹ì¸ ìš”ì²­ ë²„íŠ¼ ì¶”ê°€ -->
        </tr>
        </thead>
        <tbody id="taskBody"></tbody>
    </table>


    <!-- ğŸ”¹ğŸ“Œ API ì—°ë™ JS -->
    <script>

        /***************************************************
         ğŸ”¹ ê³µí†µ GET í•¨ìˆ˜ (Authorization ìë™ í¬í•¨)
         ****************************************************/
        async function apiGet(url) {
            const token = localStorage.getItem("accessToken");

            const res = await fetch(url, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                }
            });

            if (res.status === 401) {
                alert("ì„¸ì…˜ ë§Œë£Œ. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”");
                localStorage.clear();
                window.location.href = "/web/login";
                return null;
            }

            return res.json();
        }

        /***************************************************
         ğŸ”¹ í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
         ****************************************************/
        document.addEventListener("DOMContentLoaded", loadTasks);

        async function loadTasks() {
            const res = await apiGet(`/erp/api/v1/task/me`);

            if (!res) return;

            const tasks = Array.isArray(res) ? res : res.data ?? [];

            updateStats(tasks);
            renderTasks(tasks);

            document.getElementById("searchInput").oninput = () => renderTasks(tasks);
            document.getElementById("filterSelect").onchange = () => renderTasks(tasks);
        }

        /***************************************************
         ğŸ”¹ í…Œì´ë¸” ë Œë”ë§ + ìŠ¹ì¸ìš”ì²­ ë²„íŠ¼ í¬í•¨
         ****************************************************/
        function renderTasks(tasks) {
            const tbody = document.getElementById("taskBody");
            const keyword = document.getElementById("searchInput").value.toLowerCase();
            const filter = document.getElementById("filterSelect").value;

            tbody.innerHTML = "";

            tasks
                .filter(t =>
                    filter === "ALL" ||
                    (filter === "IN_PROGRESS" && t.status === "ì§„í–‰ ì¤‘") ||
                    (filter === "WAITING" && t.status === "ì‹œì‘ ì „") ||
                    (filter === "DONE" && t.status === "ì™„ë£Œ")
                )
                .filter(t => t.title.toLowerCase().includes(keyword))
                .forEach(t => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${t.title}</td>
                            <td>${t.description ?? '-'}</td>
                            <td>${formatDate(t.dueDate)}</td>
                            <td>${badge(t.status)}</td>
                            <td>
                                ${t.status !== "ì™„ë£Œ"
                        ? `<button class="approve-btn" onclick="requestApproval(${t.id})">ìŠ¹ì¸ ìš”ì²­</button>`
                        : `<span style="color:#999;">-</span>`
                    }
                            </td>
                        </tr>`;
                });
        }

        /***************************************************
         ğŸ”¹ ìŠ¹ì¸ ìš”ì²­ (ì—…ë¬´ ìƒíƒœ DONEìœ¼ë¡œ ë³€ê²½)
         ****************************************************/
        async function requestApproval(taskId) {

            if (!confirm("ì—…ë¬´ë¥¼ ì™„ë£Œ(DONE) ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            const token = localStorage.getItem("accessToken");

            const res = await fetch(`/erp/api/v1/task/${taskId}/status?status=DONE`, {
                method: "PATCH",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                }
            });

            if (!res.ok) {
                alert("ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨");
                return;
            }

            alert("ìŠ¹ì¸ ìš”ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
            loadTasks(); // ë‹¤ì‹œ ë¡œë“œ
        }

        /***************************************************
         ğŸ”¹ í†µê³„ ì—…ë°ì´íŠ¸
         ****************************************************/
        function updateStats(tasks) {
            document.getElementById("progressCount").innerText =
                tasks.filter(t => t.status === "ì§„í–‰ ì¤‘").length;

            document.getElementById("waitingCount").innerText =
                tasks.filter(t => t.status === "ì‹œì‘ ì „").length;

            document.getElementById("doneCount").innerText =
                tasks.filter(t => t.status === "ì™„ë£Œ").length;
        }

        /***************************************************
         ğŸ”¹ ìƒíƒœ ë±ƒì§€ ë³€í™˜
         ****************************************************/
        function badge(status) {
            return status === "ì§„í–‰ ì¤‘"
                ? `<span class="status in-progress">ì§„í–‰ ì¤‘</span>`
                : status === "ì™„ë£Œ"
                    ? `<span class="status done">ì™„ë£Œ</span>`
                    : `<span class="status waiting">ì‹œì‘ ì „</span>`;
        }

        function formatDate(date) {
            if (!date) return "-";

            if (Array.isArray(date)) {
                const [year, month, day] = date;
                return `${year}.${String(month).padStart(2, '0')}.${String(day).padStart(2, '0')}`;
            }

            return date.replace(/-/g, ".");
        }

    </script>

    <!-- ğŸ”¹ ìŠ¹ì¸ìš”ì²­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ -->
    <style>
        .approve-btn {
            background-color: #4f83ff;
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }

        .approve-btn:hover {
            background-color: #3b6fe0;
        }
    </style>

</th:block>
</html>
